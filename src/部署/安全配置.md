---
title: 安全配置
icon: fas fa-shield-alt
order: 4
---

本项目推荐是局域网使用，若您需要做到公网环境，为了确保安全，您必须按照以下方式进行配置

## 一、安装反向代理
您可以使用任何支持反向代理的软件，推荐Docker可以在1panel中安装`OpenResty`，并配置反向代理。

## 二、配置反向代理
修改反向代理站点配置文件 添加以下内容
```yml
    location /api/ {
        # 检查自定义请求头
        if ($http_替换为你的自定义请求头 != "替换你的密码") {
            return 403;
        }
        
        # 转发到后端服务 端口若有更改请自行修改
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 可选
    location /api/docs {
        # 公开访问，不检查API密钥 端口若有更改请自行修改
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
完整内容
```yml
server {
    listen 80 ; 
    server_name 47.239.194.151; 
    index index.php index.html index.htm default.php default.htm default.html; 
    proxy_set_header Host $host; 
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    proxy_set_header X-Forwarded-Host $server_name; 
    proxy_set_header X-Real-IP $remote_addr; 
    proxy_http_version 1.1; 
    proxy_set_header Upgrade $http_upgrade; 
    proxy_set_header Connection $http_connection; 
    access_log /www/sites/47.239.194.151/log/access.log main; 
    error_log /www/sites/47.239.194.151/log/error.log; 
    location ^~ /.well-known/acme-challenge {
        allow all; 
        root /usr/share/nginx/html; 
    }
    location /api/ {
        # 检查自定义请求头
        if ($http_x_api_key != "123123") {
            return 403;
        }
        
        # 转发到后端服务
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/docs {
        # 公开访问，不检查API密钥
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    include /www/sites/47.239.194.151/proxy/*.conf; 
}
```

## 三、验证更改
您现在可以访问反代后的端口，正常来讲，您应当会出现上传内容失败。需要在`设置`页面中填写`安全配置`与上面配置反向代理一样然后点击保存然后刷新您应当就可以正常上传内容。当然您可能还会遇到以下问题

::: details 显示已连接但是上传失败
- 已连接使用的是独立websocket的连接，区别于普通请求是由服务端直接验证，所以您配置完毕后前端网页会正确添加您写的内容附加在ws建立的请求的头上，您可以从控制台中看到服务端输出日志。
- 上传内容等其它操作采用的是普通http请求，这时由您的反向代理负责验证，但是您可能错误的配置了请求头或反向代理的站点配置文件导致验证不通过
:::

## 四、设置Docker端口
:::danger
此步骤您必须确保第三步设置完毕后没有任何问题再进行下面操作
:::

上面的方法我们成功实现了验证，接下来最重要的步骤是一定要将http请求的端口（默认3001）关闭对外访问，您可以通过多种方式关闭
1. 若您有防火墙，您可以直接防火墙规则中设置拒绝
2. 若您是内网穿透，您可以修改或删除此穿透的端口

若您无法满足上述条件，您需要在Docker中在端口映射中，将此端口对应宿主机端口前面加上`127.0.0.1:3001`这将表示此端口将不允许从外部连入。